<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse & Prédictions Saint-André (2014-2026)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto:wght&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap'); /* Ajout pour l'esthétique futuriste */
        
        body {
            /* Dark Mode par défaut */
            font-family: 'Roboto', sans-serif;
            background-color: #121212; 
            color: #e0e0e0; 
        }
        
        h1, h2, h3, h4 {
            font-family: 'Montserrat', sans-serif;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        .metric-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        /* Style pour le slider personnalisé */
        .range-orange::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f97316; /* Orange-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #1f2937; /* Gray-800 */
        }
        
        /* --- Styles du Speedometer (CMP) --- */
        .gauge-container {
            width: 280px; /* Légèrement réduit pour l'intégration */
            height: 140px;
            overflow: hidden;
            position: relative;
            margin: 0 auto;
        }

        .gauge-meter {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            /* Dégradé des zones de couleur: Rouge (0-30), Orange (30-60), Vert (60-100) */
            background: conic-gradient(
                #ef4444 0% 30%, 
                #f97316 30% 60%, 
                #10b981 60% 100%
            );
            position: absolute;
            top: 0;
            left: 0;
            clip: rect(0, 280px, 140px, 0); /* Masque la moitié inférieure */
        }

        .gauge-inner-circle {
            width: 240px;
            height: 240px;
            background-color: #121212; /* Fond de l'application */
            border-radius: 50%;
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .gauge-needle-container {
            position: absolute;
            top: 140px;
            left: 140px;
            transform-origin: 0 0;
            transition: transform 0.5s ease-in-out;
            z-index: 10;
        }

        .gauge-needle {
            width: 120px;
            height: 3px;
            background-color: #e5e7eb; 
            position: absolute;
            top: -1.5px;
            left: 20px;
            transform-origin: 0 50%;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(229, 231, 235, 0.5);
        }

        .gauge-needle-center {
            width: 16px;
            height: 16px;
            background-color: #e5e7eb;
            border-radius: 50%;
            position: absolute;
            top: -8px;
            left: 0;
            box-shadow: 0 0 10px #e5e7eb;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-blue-900 to-cyan-700 text-white p-8 md:p-12 shadow-lg">
        <div class="max-w-6xl mx-auto text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 tracking-tight">SAINT-ANDRÉ : LE MODÈLE PRÉDICTIF</h1>
            <p class="text-xl md:text-2xl font-light text-cyan-100">Analyse Historique (2014-2020) & Projections Stratégiques (2026)</p>
            <div class="mt-8 flex justify-center space-x-4">
                <div class="bg-white/10 backdrop-blur-md rounded-full px-6 py-2 border border-white/20">
                    <span class="font-bold">2014</span> ➔ <span class="font-bold">2020 (Validé)</span> ➔ <span class="font-bold">2026 (Projeté)</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-12">

        <!-- 1. CONTEXTE 2020 -->
        <section class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold text-cyan-400 mb-4 border-b-4 border-pink-500 inline-block pb-1">1. L'Anatomie de la Bascule (2020)</h2>
            <p class="text-lg text-gray-200 leading-relaxed mb-6">
                L'analyse des données réelles montre que la victoire de Joé Bedier en 2020 ne repose pas sur une simple érosion démographique, mais sur une **abstention record** (+25 pts) et une **unification massive des reports de voix** au second tour.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="bg-blue-900/50 p-4 rounded-lg metric-card border border-blue-700">
                    <div class="text-4xl font-bold text-blue-300">+7 953</div>
                    <div class="text-sm text-blue-400 font-semibold uppercase tracking-wide">Nouveaux Inscrits (2014-2020)</div>
                </div>
                <div class="bg-pink-900/50 p-4 rounded-lg metric-card border border-pink-700">
                    <div class="text-4xl font-bold text-pink-300">+25 pts</div>
                    <div class="text-sm text-pink-400 font-semibold uppercase tracking-wide">Explosion de l'Abstention</div>
                </div>
                <div class="bg-cyan-900/50 p-4 rounded-lg metric-card border border-cyan-700">
                    <div class="text-4xl font-bold text-cyan-300">47,8%</div>
                    <div class="text-sm text-cyan-400 font-semibold uppercase tracking-wide">Taux de Report vers Bedier</div>
                </div>
            </div>
        </section>

        <!-- GRAPHIQUES HISTORIQUES -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div class="order-2 md:order-1 bg-gray-800 rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-100 mb-2">Le Paradoxe Démographique</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Croissance du corps électoral vs Effondrement de la participation.
                </p>
                <div class="chart-container">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
            <div class="order-1 md:order-2 space-y-4">
                <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-100 mb-2">Réserves de Voix (1er Tour 2020)</h3>
                    <p class="text-gray-400 text-sm mb-4">
                        Le camp Virapoullé avait fait le plein dès le 1er tour (83% de mobilisation), tandis que Bedier disposait d'une forte réserve.
                    </p>
                    <div class="chart-container">
                        <canvas id="mobilizationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- LE POOL DE REPORT 2020 -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1 bg-gradient-to-br from-gray-900 to-gray-950 text-white rounded-xl shadow-lg p-6 flex flex-col justify-center border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-amber-400">Le "Pool" 2020</h3>
                <p class="mb-6 text-gray-400">
                    Au soir du 1er tour 2020, **10 210 voix** (listes éliminées) étaient disponibles. C'est la clé du scrutin.
                </p>
                <div class="text-5xl font-extrabold text-white mb-2">10 210</div>
                <div class="text-sm text-gray-500 uppercase tracking-widest">Voix à redistribuer</div>
            </div>
            <div class="md:col-span-2 bg-gray-800 rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-100 mb-4">Composition des Voix Éliminées (2020)</h3>
                <p class="text-sm text-gray-400 mb-4">Détail des forces (dont Ramassamy et Moutoucomorapoulé) qui ont basculé.</p>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="poolChart"></canvas>
                </div>
            </div>
        </section>


        <!-- 2. VALIDATION DU MODÈLE -->
        <section class="bg-gray-700 rounded-xl shadow-lg p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold text-cyan-400 mb-2">2. Validation du Modèle Prédictif</h2>
            <p class="text-gray-200 mb-6">
                Le modèle, même dans sa forme simplifiée, a prédit les résultats de 2020 avec une précision remarquable. Application de la formule historique : <code class="bg-gray-800 text-white px-2 py-1 rounded text-sm font-mono">V2 = V1 + (Pool × Taux)</code>.
            </p>
            <div class="chart-container">
                <canvas id="validationChart"></canvas>
            </div>
            <div class="mt-8 overflow-x-auto">
                <table class="w-full text-left border-collapse bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                    <thead class="bg-gray-900 text-white">
                        <tr>
                            <th class="p-4">Candidat</th>
                            <th class="p-4">Prédiction</th>
                            <th class="p-4">Réel (2020)</th>
                            <th class="p-4 text-right">Précision</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-700">
                            <td class="p-4 font-bold text-blue-400">J.M. VIRAPOULLÉ</td>
                            <td class="p-4 text-gray-100">9 809</td>
                            <td class="p-4 text-gray-100">9 813</td>
                            <td class="p-4 text-right text-green-400 font-bold">99,96%</td>
                        </tr>
                        <tr>
                            <td class="p-4 font-bold text-cyan-400">Joé BEDIER</td>
                            <td class="p-4 text-gray-100">10 702</td>
                            <td class="p-4 text-gray-100">10 703</td>
                            <td class="p-4 text-right text-green-400 font-bold">99,99%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 3. PROJECTION 2026 - PREMIER TOUR (FORMULE COMPLEXE) -->
        <section id="projection2026_premier_tour" class="bg-gray-700 rounded-xl shadow-lg p-6 md:p-8 border-4 border-cyan-500">
            <h2 class="text-2xl md:text-3xl font-bold text-cyan-400 mb-4 border-b-4 border-cyan-500 inline-block pb-1">3. Projection 1er Tour 2026 (Modèle Dynamique du Vote)</h2>
            
            <p class="text-lg text-gray-200 leading-relaxed mb-6">
                Nous utilisons un modèle de dynamique électorale pour estimer les voix $V_{i, t}$ du candidat $i$ au temps $t=2026$. Ce modèle combine la fidélité historique et l'attraction actuelle, modulées par le paramètre d'érosion ($\epsilon$) et la participation ($\pi$).
            </p>
            
            <!-- FORMULE MATHÉMATIQUE -->
            <div class="bg-gray-900 p-6 rounded-lg mb-8 shadow-inner border border-yellow-500/50 overflow-x-auto">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">Équation de Projection (1er Tour)</h3>
                <div class="text-xl font-mono text-white leading-relaxed">
                    $$V_{i, t} = \pi \cdot \left[ (1 - \epsilon) \cdot V_{i, t-1} + \epsilon \cdot \left( \frac{A_i}{\sum_{j} A_j} \cdot V_{i, t}^{proj} \right) \right]$$
                </div>
                <p class="text-sm text-gray-400 mt-4">Où :</p>
                <ul class="text-sm text-gray-400 list-disc list-inside space-y-1 mt-2">
                    <li>$V_{i, t}$ : Voix projetées pour le candidat $i$ en 2026.</li>
                    <li>$\pi$ : Taux de Participation ajusté du scrutin (Slider).</li>
                    <li>$\epsilon$ : Paramètre d'Érosion/Momentum (Slider) entre 0 (Mémoire totale) et 1 (Momentum pur).</li>
                    <li>$V_{i, t-1}$ : Voix obtenues en 2014 (Représente la base historique de fidélité).</li>
                    <li>$V_{i, t}^{proj}$ : Poids des voix estimé pour $i$ basé sur les sondages/réalité de 2026.</li>
                    <li>$A_i / \sum A_j$ : Facteur d'Attraction Normalisé, modélisant la "distance" entre les candidats et le vote disponible.</li>
                </ul>
            </div>
            
            <!-- GAUGE DE MOMENTUM -->
            <div class="bg-gray-900 p-6 rounded-xl mb-8 shadow-inner border border-green-700/50 text-center">
                <h3 class="text-xl font-bold mb-2 text-green-400 tracking-wider">
                    Courbe de Momentum Politique (CMP)
                </h3>
                <div class="gauge-container">
                    <div class="gauge-meter"></div>
                    <div class="gauge-inner-circle"></div>
                    <div id="gaugeNeedleContainer" class="gauge-needle-container" style="transform: rotate(-90deg);">
                        <div class="gauge-needle"></div>
                        <div class="gauge-needle-center"></div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <p class="text-5xl font-bold tracking-tight text-white">
                        <span id="cmpValue" class="text-yellow-400">50.0</span>
                        <span class="text-xl text-gray-400">/ 100</span>
                    </p>
                    <p id="cmpStatus" class="text-xl mt-2 font-medium text-yellow-400">Zone de turbulence</p>
                </div>
            </div>


            <!-- SLIDER DE PARTICIPATION -->
            <div class="bg-gray-900 p-6 rounded-lg mb-8 shadow-inner border border-green-700">
                <label for="participation-slider" class="block text-xl font-bold text-green-400 mb-3">
                    Taux de Participation (1er Tour) : <span id="participation-value" class="text-2xl font-extrabold text-white ml-2">55%</span>
                </label>
                <input type="range" id="participation-slider" min="40" max="80" value="55" step="1" 
                       class="w-full h-2 bg-green-700 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>40% (Forte Abstention)</span>
                    <span>80% (Forte Mobilisation)</span>
                </div>
                <div class="mt-4 pt-2 border-t border-gray-700 grid grid-cols-2 gap-4 text-sm font-semibold">
                    <div>
                        <span class="text-gray-400">Votants (Inscrits : 42 680):</span>
                        <span id="total-voters-2026" class="text-green-300 ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Abstentionnistes :</span>
                        <span id="abstention-2026" class="text-red-400 ml-2"></span>
                    </div>
                </div>
            </div>

            <!-- SLIDER D'ÉROSION -->
            <div class="bg-gray-900 p-6 rounded-lg mb-8 shadow-inner border border-purple-700">
                <label for="erosion-slider" class="block text-xl font-bold text-purple-300 mb-3">
                    Paramètre d'Érosion ($\epsilon$) : <span id="erosion-value" class="text-2xl font-extrabold text-white ml-2">0.50</span>
                </label>
                <input type="range" id="erosion-slider" min="0" max="100" value="50" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>$\epsilon$ = 0 (Fidélité Totale au Passé 2014)</span>
                    <span>$\epsilon$ = 1 (Seul le Présent Compte)</span>
                </div>
            </div>
            
             <!-- SLIDER SCORE PROJETÉ (pour le CMP) -->
            <div class="bg-gray-900 p-6 rounded-lg mb-8 shadow-inner border border-blue-700">
                <label for="score-projeté-slider" class="block text-xl font-bold text-blue-300 mb-3">
                    Score Projeté du Candidat (JMV/Opposition) : <span id="score-projeté-value" class="text-2xl font-extrabold text-white ml-2">25%</span>
                </label>
                <input type="range" id="score-projeté-slider" min="10" max="50" value="25" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>10% (Score Faible)</span>
                    <span>50% (Score Fort)</span>
                </div>
                <p class="text-xs text-gray-500 mt-1 italic">Ce score représente la force initiale du candidat principal de l'opposition au 1er tour.</p>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="order-2 md:order-1">
                    <h3 class="text-xl font-bold text-gray-100 mb-4">Répartition des Forces (Ajustée)</h3>
                    <div class="chart-container">
                        <canvas id="projection1stTourChart"></canvas>
                    </div>
                </div>
                <div class="order-1 md:order-2 space-y-4" id="projection-details-1st">
                    <!-- Les résultats projetés seront injectés ici par JS -->
                </div>
            </div>
        </section>

        <!-- 4. PROJECTION 2026 - SECOND TOUR -->
        <section id="projection2026_second_tour" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 border-4 border-amber-500">
            <h2 class="text-2xl md:text-3xl font-bold text-amber-400 mb-4 border-b-4 border-amber-500 inline-block pb-1">4. Projection 2nd Tour 2026 (Duel Dynamique)</h2>
            <p class="text-lg text-gray-200 leading-relaxed mb-6">
                Ce duel est calculé en temps réel en fonction des résultats du 1er tour et du paramètre d'arbitrage ci-dessous.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-100 mb-4">Duel Projeté</h3>
                    <div class="chart-container">
                        <canvas id="projection2ndTourChart"></canvas>
                    </div>
                </div>
                <div class="space-y-4" id="projection-details-2nd">
                    <!-- Les résultats du 2nd tour seront injectés ici par JS -->
                </div>
            </div>
        </section>

        <!-- 5. ARBITRAGE LAURENT (MINIMUM CORRIGÉ À 10%) -->
        <section class="bg-gray-700 rounded-xl shadow-lg p-6 md:p-8 border-4 border-orange-500">
            <h2 class="text-2xl md:text-3xl font-bold text-orange-400 mb-4 border-b-4 border-orange-500 inline-block pb-1">5. Le Facteur Arbitre : Soutien du Pool Laurent</h2>
            <p class="text-lg text-gray-200 leading-relaxed mb-6">
                Le Pool Droit Indépendant (Laurent) est l'arbitre du 2nd tour. Simulez ici le niveau de son ralliement à l'Opposition (JMV Consolidé) pour voir son impact direct sur le résultat final.
            </p>

            <!-- SLIDER ARBITRAGE LAURENT - MINIMUM CORRIGÉ À 10 -->
            <div class="bg-gray-900 p-6 rounded-lg mb-8 shadow-inner">
                <label for="laurent-arbitrage-slider" class="block text-xl font-bold text-orange-300 mb-3">
                    % de Ralliement du Pool Laurent vers l'Opposition (JMV) : <span id="laurent-arbitrage-value" class="text-2xl font-extrabold text-white ml-2">85%</span>
                </label>
                <input type="range" id="laurent-arbitrage-slider" min="10" max="100" value="85" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg range-orange">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>10% (Ralliement Très Faible)</span>
                    <span>100% (Ralliement Total)</span>
                </div>
            </div>
            
            <p class="text-sm text-gray-400 italic mt-4">
                *Note : Les voix restantes (après report JMV et 5% fixe pour Bedier) sont considérées comme de l'abstention.
            </p>
        </section>


        <footer class="text-center py-12 space-y-4">
            <h3 class="text-2xl font-bold text-gray-200">Conclusion</h3>
            <p class="max-w-2xl mx-auto text-gray-400">
                L'élection de 2026 s'annonce comme le miroir inversé de 2020. La capacité du sortant à rallier l'électorat de gauche d'Eric Fruteau sera critique. Cependant, la clé de la victoire au second tour résidera dans le **pool de voix de Droite Indépendante (associé à Laurent)**, dont le report sera l'arbitre incontournable du scrutin. La consolidation de l'Opposition autour de ces voix est la menace principale pour le sortant.
            </p>
            <div class="text-xs text-gray-500 mt-8">
                Généré par Canvas Infographics
            </div>
        </footer>

    </main>

    <script>
        // Configuration Globale
        const FONT_COLOR = '#e0e0e0';
        const GRID_COLOR = 'rgba(224, 224, 224, 0.1)';
        
        // --- CONSTANTES DE BASE (SAINT-ANDRÉ 2020) ---
        const TOTAL_REGISTERED_VOTERS = 42680; // Inscrits 2020 (Base de calcul pour 2026)
        const BLANK_NULL_RATE = 0.05; // 5% de votes blancs ou nuls
        const VOTES_BASE_REFERENCE = 24510; // Total des voix exprimées dans la projection V_CURRENT_BASE (2020 réel)
        
        // État dynamique des votes totaux (mis à jour par le slider de participation)
        let dynamicTotalVotes2026 = VOTES_BASE_REFERENCE; 
        let laurentSupportRate = 0.85; // Initialisation à 85% (valeur par défaut du slider Arbitrage)
        
        // --- Poids CMP (NOUVEAU) ---
        const WEIGHT_P = 0.4; // Poids Participation (max 80%)
        const WEIGHT_E = 0.4; // Poids (1 - Érosion)
        const WEIGHT_S = 0.2; // Poids Score projeté (max 50%)


        
        // Données du Modèle d'Érosion pour le 1er tour 2026
        // V_i, t-1 (Historique 2014) - Voix réelles 2014 pour la fidélité
        const V_2014_BASE = {
            'JMV Consolidé': 9756,    
            'Joé Bedier': 7851,       
            'Eric Fruteau': 6345,     
            'Pool Droit Indépendant (Laurent)': 3558  
        };
        // V_i, t^proj (Projeté Actuel) - Estimation de la force actuelle du candidat (Attraction A_i)
        const V_CURRENT_BASE = {
            'JMV Consolidé': 12000, // Forte attraction actuelle estimée
            'Joé Bedier': 9000,
            'Eric Fruteau': 4000,
            'Pool Droit Indépendant (Laurent)': 6000 // Le pool Laurent est volatile, son attraction est moyenne/élevée
        };
        // Total de la base projetée pour la normalisation de l'Attraction
        const TOTAL_V_CURRENT_BASE = Object.values(V_CURRENT_BASE).reduce((sum, val) => sum + val, 0);


        // Modèle de Report du 1er au 2nd Tour (Estimation)
        // Les pourcentages sont: [Vers JMV, Vers Bedier, Abstention]
        const REPORT_RATES_BASE = {
            'Eric Fruteau': { 'JMV Consolidé': 0.30, 'Joé Bedier': 0.60, 'Abstention': 0.10 },
            // Le pool Laurent est géré par le slider dynamique (Section 6)
        };
        
        // Initialisation des variables globales des graphiques
        let projection1stTourChart = null;
        let projection2ndTourChart = null;


        // --- Fonctions d'Utilité Chart.js ---

        function wrapLabel(label) {
            if (label.length <= 16) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length <= 16) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        const tooltipConfig = {
            callbacks: {
                title: function(tooltipItems) {
                    const item = tooltipItems[0];
                    let label = item.chart.data.labels[item.dataIndex];
                    if (Array.isArray(label)) {
                        return label.join(' ');
                    } else {
                        return label;
                    }
                },
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        label += Math.round(context.parsed.y).toLocaleString('fr-FR') + ' voix';
                        if (context.dataset.label === 'Projection 2026' || context.dataset.label === 'Voix (Projection 1er Tour 2026)') {
                             // Le total pour le pourcentage est dynamique
                             // Pour le 1er tour, on utilise dynamicTotalVotes2026
                             const total = dynamicTotalVotes2026; 
                             const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                             label += ` (${percentage}%)`;
                        }
                    }
                    return label;
                }
            }
        };

        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                tooltip: tooltipConfig,
                legend: { labels: { color: FONT_COLOR } }
            },
            backgroundColor: 'transparent' 
        };
        
        // --- Fonction de Calcul des Votes Totaux (Nouveau) ---

        function calculateTotalVotes2026() {
            const participationRateInput = document.getElementById('participation-slider');
            const participationRate = parseInt(participationRateInput.value, 10) / 100;
            
            const totalVoters = TOTAL_REGISTERED_VOTERS * participationRate;
            const abstention = TOTAL_REGISTERED_VOTERS - totalVoters;
            const expressedVotes = totalVoters * (1 - BLANK_NULL_RATE);
            
            // Mise à jour de la variable globale
            // Note: Nous utilisons le total ajusté par la participation comme base pour V_i,t
            dynamicTotalVotes2026 = Math.round(expressedVotes);

            // Mise à jour de l'interface utilisateur
            document.getElementById('participation-value').textContent = (participationRate * 100).toFixed(0) + '%';
            document.getElementById('total-voters-2026').textContent = Math.round(totalVoters).toLocaleString('fr-FR');
            document.getElementById('abstention-2026').textContent = Math.round(abstention).toLocaleString('fr-FR');
            
            return dynamicTotalVotes2026;
        }

        // --- Fonctions CMP (NOUVEAU) ---

        /**
         * Calcule la Courbe de Momentum Politique (CMP).
         * Utilise les valeurs des 3 sliders (participation, érosion, score projeté).
         */
        function calculateCMP() {
            // Récupérer les valeurs des sliders (normalisées sur 0-100)
            const participation = parseFloat(document.getElementById('participation-slider').value);
            const erosion = parseFloat(document.getElementById('erosion-slider').value);
            const score = parseFloat(document.getElementById('score-projeté-slider').value); // Le score est déjà un % 
            
            // Érosion (epsilon) est une résistance, on utilise donc (100 - erosion) pour la force dans le CMP.
            // CMP (Momentum) est plus fort si l'érosion (mémoire) est faible, et si l'attraction (score) est forte.
            const nonErosion = 100 - erosion;

            // CMP = (Participation / 100) * 0.4 + (1 - Érosion / 100) * 0.4 + (Score / 100) * 0.2
            // Et multiplier par 100 à la fin, OU, utiliser les valeurs 0-100 directement:
            
            const cmp = (participation * WEIGHT_P) + 
                        (nonErosion * WEIGHT_E) + 
                        (score * WEIGHT_S);

            // Arrondir à une décimale
            return parseFloat(cmp.toFixed(1));
        }

        /**
         * Met à jour la jauge Speedometer et les valeurs d'affichage.
         * @param {number} cmp - La valeur CMP (0-100).
         */
        function updateGauge(cmp) {
            const cmpValueDisplay = document.getElementById('cmpValue');
            const cmpStatusDisplay = document.getElementById('cmpStatus');
            const gaugeNeedleContainer = document.getElementById('gaugeNeedleContainer');

            // 1. Mise à jour de l'affichage de la valeur
            cmpValueDisplay.textContent = cmp.toFixed(1);

            // 2. Définition du Statut et de la Couleur (basé sur 0-30 rouge, 30-60 orange, 60-100 vert)
            let statusText = '';
            let statusColor = '';
            
            if (cmp < 30) {
                statusText = 'Terrain hostile (Risque Élevé)';
                statusColor = '#ef4444'; // Rouge
            } else if (cmp < 60) {
                statusText = 'Zone de turbulence (Instabilité)';
                statusColor = '#f97316'; // Orange
            } else {
                statusText = 'Momentum positif (Avantage Stratégique)';
                statusColor = '#10b981'; // Vert
            }

            cmpStatusDisplay.textContent = statusText;
            cmpStatusDisplay.style.color = statusColor;
            cmpValueDisplay.style.color = statusColor;

            // 3. Animation de l'aiguille de la jauge
            // L'angle va de -90 degrés (0 CMP) à +90 degrés (100 CMP).
            const angle = (cmp / 100) * 180 - 90;
            gaugeNeedleContainer.style.transform = `rotate(${angle}deg)`;
        }


        // --- Fonction du Modèle d'Érosion (Section 3 - Formule Complexe) ---

        function calculate2026Projection(epsilon) {
            
            // Facteur de Participation (pi) - Ajusté par le total des voix exprimées
            const expressedVotes = dynamicTotalVotes2026;
            
            const results = {};
            const keys = Object.keys(V_CURRENT_BASE).filter(key => key !== 'Joé Bedier'); // Exclure Bedier de la boucle pour le recalcul
            keys.push('Joé Bedier'); // Ajouter Bedier à la fin
            let totalProjectedVotes = 0;

            
            // --- Ajustement dynamique V_CURRENT_BASE pour JMV/Bedier ---
            // Déplacé dans updateSimulation pour être exécuté avant calculate2026Projection
            
            // --- Vérification du total après ajustement ---
            // Le TOTAL_V_CURRENT_BASE est maintenant le total de la base projetée des 4 candidats.
            const currentTotalVCurrentBase = Object.values(V_CURRENT_BASE).reduce((sum, val) => sum + val, 0);


            for (const key of keys) {
                
                // 1. Calcul du Facteur d'Attraction Normalisé (A_i / Sum A_j)
                const attractionFactor = V_CURRENT_BASE[key] / currentTotalVCurrentBase;
                
                // 2. Application de la formule :
                // V_i, t = (1 - epsilon) * V_i, t-1 + epsilon * (AttractionFactor * expressedVotes)
                
                // Terme Fidélité Historique (V_i, t-1)
                const fidelityTerm = V_2014_BASE[key];
                
                // Terme Attraction (V_i, t^proj) - ajusté au total des voix dynamiques
                const attractionTerm = attractionFactor * expressedVotes; 
                
                // Combinaison des termes selon epsilon (Équation finale)
                const projectedVotes = (1 - epsilon) * fidelityTerm + epsilon * attractionTerm;
                
                results[key] = projectedVotes; 
                totalProjectedVotes += results[key];
            }

            // Normalisation finale (Réajustement pour s'assurer que Sum V_i, t = expressedVotes)
            const scalingFactor = expressedVotes / totalProjectedVotes;
            const finalResults = {};
            
            for (const key of Object.keys(results)) {
                finalResults[key] = Math.round(results[key] * scalingFactor);
            }

            return finalResults;
        }

        // --- Fonctions de Mise à Jour de l'Interface ---

        function updateSimulation() {
            // 1. Mise à jour de l'affichage du Score Projeté
            const scoreSlider = document.getElementById('score-projeté-slider');
            const scorePercentage = parseInt(scoreSlider.value);
            document.getElementById('score-projeté-value').textContent = scorePercentage + '%';
            
            // Mise à jour de V_CURRENT_BASE[JMV Consolidé] basée sur le slider "Score Projeté"
            // Le slider module la répartition de la base de voix principale (JMV + Bedier)
            // Calcul de la base totale pour JMV et Bedier dans V_CURRENT_BASE (Statique)
            const JMV_BEDIER_BASE_SUM = V_CURRENT_BASE['JMV Consolidé'] + V_CURRENT_BASE['Joé Bedier'];
            
            // V_CURRENT_BASE['JMV Consolidé'] = (Score Projeté / 100) * (Somme JMV+Bedier)
            V_CURRENT_BASE['JMV Consolidé'] = Math.round((scorePercentage / 100) * JMV_BEDIER_BASE_SUM);
            V_CURRENT_BASE['Joé Bedier'] = JMV_BEDIER_BASE_SUM - V_CURRENT_BASE['JMV Consolidé'];


            // 2. Calculer le Momentum (CMP)
            const cmp = calculateCMP();
            updateGauge(cmp);

            // 3. Calculer le nouveau total de votes exprimés basé sur la participation
            const newTotalVotes = calculateTotalVotes2026();
            
            // 4. Lire le paramètre d'érosion
            const erosionSlider = document.getElementById('erosion-slider');
            const epsilon = parseInt(erosionSlider.value, 10) / 100;
            document.getElementById('erosion-value').textContent = epsilon.toFixed(2);
            
            // 5. Calculer la projection du 1er tour
            const firstTourResults = calculate2026Projection(epsilon);

            // 6. Mettre à jour les graphiques et détails du 1er tour
            updateProjectionChartAndDetails(epsilon, firstTourResults);
            
            // 7. Déclencher le calcul du 2nd tour (qui utilise les résultats du 1er tour)
            updateSecondTourProjection(firstTourResults);
        }

        function updateProjectionChartAndDetails(epsilon, results) {
            const dataArray = Object.values(results);
            
            // Mise à jour du graphique 1er Tour
            if (projection1stTourChart) {
                projection1stTourChart.data.datasets[0].data = dataArray;
                // Ajuster l'axe Y pour la lisibilité
                const maxVal = Math.max(...dataArray);
                projection1stTourChart.options.scales.y.max = Math.ceil(maxVal / 1000) * 1000 + (maxVal < 10000 ? 500 : 1000);
                projection1stTourChart.update();
            }

            // Mise à jour du panneau de détails 1er Tour
            const detailsPanel = document.getElementById('projection-details-1st');
            detailsPanel.innerHTML = '';
            
            const displayKeys = Object.keys(results).slice(0, 4); 
            // Couleurs ajustées pour le code injection HTML
            const colorMap = {
                'JMV Consolidé': { hex: '#3b82f6', class: 'blue' },
                'Joé Bedier': { hex: '#06b6d4', class: 'cyan' },
                'Eric Fruteau': { hex: '#f59e0b', class: 'amber' },
                'Pool Droit Indépendant (Laurent)': { hex: '#f97316', class: 'orange' }
            };

            let htmlContent = '';
            
            displayKeys.forEach((key) => {
                const votes = results[key];
                // Le pourcentage est basé sur le total dynamique des votes exprimés
                const percentage = ((votes / dynamicTotalVotes2026) * 100).toFixed(1);
                
                const colorInfo = colorMap[key];

                htmlContent += `
                    <div class="bg-${colorInfo.class}-900/50 border-l-4 border-${colorInfo.class}-500 p-4">
                        <h4 class="font-bold text-${colorInfo.class}-300">${key.replace('Pool Droit Indépendant (Laurent)', 'Pool Laurent')} : ${percentage}%</h4>
                        <p class="text-sm text-${colorInfo.class}-200">${votes.toLocaleString('fr-FR')} voix projetées</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                            <div class="h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${colorInfo.hex}"></div>
                        </div>
                    </div>
                `;
            });
            
            detailsPanel.innerHTML = htmlContent;
        }
        
        function updateSecondTourProjection(firstTourResults) {
            
            const c1 = 'JMV Consolidé';
            const v1_1st = firstTourResults[c1];
            const c2 = 'Joé Bedier';
            const v2_1st = firstTourResults[c2];

            const eliminatedCandidates = Object.entries(firstTourResults).filter(([name]) => name !== c1 && name !== c2);
            
            let v1_2nd = v1_1st; 
            let v2_2nd = v2_1st; 
            let totalReportedVotes = 0;

            // Facteur de correction (simple) pour la participation au 2nd tour
            // Simplification : le total des voix du 1er tour est notre base pour les reports.

            eliminatedCandidates.forEach(([eliminatedName, eliminatedVotes]) => {
                
                // Cas Spécifique : Pool Droit Indépendant (Laurent)
                if (eliminatedName === 'Pool Droit Indépendant (Laurent)') {
                    const reportJMV = laurentSupportRate;
                    const reportBedier = 0.05;

                    v1_2nd += Math.round(eliminatedVotes * reportJMV);
                    v2_2nd += Math.round(eliminatedVotes * reportBedier);
                    
                    totalReportedVotes += Math.round(eliminatedVotes * (reportJMV + reportBedier));

                } else if (REPORT_RATES_BASE[eliminatedName]) {
                    // Cas Général (Eric Fruteau)
                    const rates = REPORT_RATES_BASE[eliminatedName];
                    
                    v1_2nd += Math.round(eliminatedVotes * (rates[c1] || 0));
                    v2_2nd += Math.round(eliminatedVotes * (rates[c2] || 0));
                    
                    totalReportedVotes += Math.round(eliminatedVotes * ((rates[c1] || 0) + (rates[c2] || 0)));
                }
            });
            
            const total2ndTourVotes = v1_2nd + v2_2nd;
            
            const winner = v1_2nd > v2_2nd ? c1 : c2;
            const loser = v1_2nd > v2_2nd ? c2 : c1;

            const v_winner = v1_2nd > v2_2nd ? v1_2nd : v2_2nd;
            const v_loser = v1_2nd > v2_2nd ? v2_2nd : v1_2nd;

            const p_winner = ((v_winner / total2ndTourVotes) * 100).toFixed(1);
            const p_loser = ((v_loser / total2ndTourVotes) * 100).toFixed(1);

            // 3. Mise à jour du graphique 2nd Tour
            if (projection2ndTourChart) {
                // Les données du 2nd tour 2026 sont aux indices 2 et 3
                const data2026 = [0, 0, v2_2nd, v1_2nd];
                
                projection2ndTourChart.data.datasets[1].data = data2026;
                // Ajuster l'axe Y pour la lisibilité
                projection2ndTourChart.options.scales.y.max = Math.ceil(Math.max(v1_2nd, v2_2nd, 10703, 9813) / 1000) * 1000 + 1000;
                projection2ndTourChart.update();
            }

            // 4. Mise à jour du panneau de détails 2nd Tour
            const detailsPanel = document.getElementById('projection-details-2nd');
            
            const colorClassWinner = winner.includes('JMV') ? 'blue' : 'cyan';
            const colorClassLoser = loser.includes('JMV') ? 'blue' : 'cyan';

            detailsPanel.innerHTML = `
                <div class="bg-gray-900 border-b-4 border-amber-500 p-4 text-center">
                    <h4 class="font-bold text-amber-300">Total Votants (2nd Tour)</h4>
                    <div class="text-3xl font-extrabold text-white mt-1">${total2ndTourVotes.toLocaleString('fr-FR')}</div>
                    <p class="text-xs text-gray-400">Total des reports pris en compte : ${totalReportedVotes.toLocaleString('fr-FR')}</p>
                </div>
                
                <div class="bg-${colorClassWinner}-900/50 border-l-4 border-${colorClassWinner}-700 p-4">
                    <h4 class="font-bold text-${colorClassWinner}-300">VAINQUEUR PROJETÉ : ${winner}</h4>
                    <p class="text-sm text-${colorClassWinner}-200">Total voix 1er tour + Reports</p>
                    <div class="text-3xl font-extrabold text-${colorClassWinner}-400 mt-2">${v_winner.toLocaleString('fr-FR')} voix (${p_winner}%)</div>
                </div>
                
                <div class="bg-${colorClassLoser}-900/50 border-l-4 border-${colorClassLoser}-500 p-4 opacity-75">
                    <h4 class="font-bold text-${colorClassLoser}-300">${loser}</h4>
                    <p class="text-sm text-${colorClassLoser}-200">Total voix 1er tour + Reports</p>
                    <div class="text-3xl font-extrabold text-${colorClassLoser}-400 mt-2">${v_loser.toLocaleString('fr-FR')} voix (${p_loser}%)</div>
                </div>
            `;
        }

        // --- Initialisation des Charts et Listeners ---
        
        window.onload = function() {
            // Initialisation des 4 premiers graphiques (démographie, mobilisation, pool, validation)
            // 1. Demographics Chart
            const ctxDemo = document.getElementById('demographicsChart').getContext('2d');
            new Chart(ctxDemo, {
                type: 'bar',
                data: {
                    labels: ['2014 (2nd Tour)', '2020 (2nd Tour)'],
                    datasets: [
                        { label: 'Inscrits (Vivier)', data: [34727, 42680], backgroundColor: '#3b82f6', order: 2, yAxisID: 'y' },
                        { label: 'Taux d\'Abstention (%)', data: [26.92, 51.94], borderColor: '#f472b6', backgroundColor: '#f472b6', type: 'line', borderWidth: 3, pointRadius: 6, order: 1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        x: { ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } },
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nombre d\'Inscrits', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Abstention (%)', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { drawOnChartArea: false, color: GRID_COLOR } }
                    }
                }
            });

            // 2. Mobilization Chart (2020)
            const ctxMob = document.getElementById('mobilizationChart').getContext('2d');
            new Chart(ctxMob, {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: ['Camp Virapoullé', 'Camp Bedier'],
                    datasets: [{ label: 'Taux de Mobilisation Idéal (%)', data: [83.2, 61.2], backgroundColor: ['#3b82f6', '#06b6d4'], borderRadius: 5 }]
                },
                options: {
                    ...commonChartOptions,
                    plugins: { legend: { display: false }, tooltip: tooltipConfig },
                    scales: { y: { ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } }, x: { max: 100, title: { display: true, text: 'Pourcentage du Potentiel Mobilisé', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } } }
                }
            });

            // 3. Pool Chart (2020)
            const ctxPool = document.getElementById('poolChart').getContext('2d');
            const poolLabels = ['E. Fruteau (LDVG)', 'J-F. Ramassamy (LDVC)', 'S. Moutoucomorapoulé (LDVC)', 'Autres Listes', 'Reports Comportementaux'].map(l => wrapLabel(l));
            new Chart(ctxPool, {
                type: 'doughnut',
                data: {
                    labels: poolLabels,
                    datasets: [{ data: [3107, 1058, 1000, 2769, 2276], backgroundColor: ['#f59e0b', '#34d399', '#f87171', '#94a3b8', '#5b21b6'], hoverOffset: 8 }]
                },
                options: { ...commonChartOptions, plugins: { tooltip: tooltipConfig, legend: { position: 'bottom', labels: { color: FONT_COLOR } } } }
            });

            // 4. Validation Chart (2020)
            const ctxVal = document.getElementById('validationChart').getContext('2d');
            const valLabels = ['J.M. Virapoullé', 'Joé Bedier'].map(l => wrapLabel(l));
            new Chart(ctxVal, {
                type: 'bar',
                data: {
                    labels: valLabels,
                    datasets: [
                        { label: 'Prédiction Modèle', data: [9809, 10702], backgroundColor: '#4b5563', borderRadius: 4 },
                        { label: 'Résultat Réel', data: [9813, 10703], backgroundColor: ['#3b82f6', '#06b6d4'], borderRadius: 4 }
                    ]
                },
                options: {
                    ...commonChartOptions,
                    scales: { x: { ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } }, y: { beginAtZero: false, min: 8000, title: { display: true, text: 'Nombre de Voix', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } } }
                }
            });
            
            // 5. Projection 2nd Tour 2026 (Initialisation dynamique)
            const ctxProj2nd = document.getElementById('projection2ndTourChart').getContext('2d');
            const proj2ndLabels = ['Bedier (2020)', 'Opp. (2020)', 'Bedier (2026 Proj.)', 'Opp. (2026 Proj.)'].map(l => wrapLabel(l));
            projection2ndTourChart = new Chart(ctxProj2nd, {
                type: 'bar',
                data: {
                    labels: proj2ndLabels,
                    datasets: [
                        // Stack 0: Données réelles 2020 (Statiques)
                        { label: 'Voix Réelles 2020', data: [10703, 9813, 0, 0], backgroundColor: ['#06b6d4', '#3b82f6', 'transparent', 'transparent'], stack: 'stack0' },
                        // Stack 1: Projection 2026 (Dynamique) - Initialisation à zéro, sera mise à jour
                        { label: 'Projection 2026', data: [0, 0, 0, 0], backgroundColor: ['transparent', 'transparent', '#06b6d4cc', '#3b82f6cc'], stack: 'stack1' }
                    ]
                },
                options: {
                    ...commonChartOptions,
                    scales: { 
                        x: { stacked: true, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } }, 
                        y: { beginAtZero: false, min: 9000, max: 15000, stacked: false, title: { display: true, text: 'Nombre de Voix (Projection)', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } } 
                    }
                }
            });


            // --- Initialisation de la Projection 1er Tour (Section 4) ---

            const ctxProj1st = document.getElementById('projection1stTourChart').getContext('2d');
            const proj1stLabels = Object.keys(V_CURRENT_BASE).map(l => wrapLabel(l.replace('Pool Droit Indépendant (Laurent)', 'Pool Laurent')));
            
            // Calculer les résultats initiaux
            calculateTotalVotes2026(); 
            const initialResults = calculate2026Projection(0.5);

            projection1stTourChart = new Chart(ctxProj1st, {
                type: 'bar',
                data: {
                    labels: proj1stLabels,
                    datasets: [{ 
                        label: 'Voix (Projection 1er Tour 2026)', 
                        data: Object.values(initialResults), 
                        backgroundColor: ['#3b82f6', '#06b6d4', '#f59e0b', '#f97316'], // Orange pour Pool Laurent
                        borderRadius: 4 
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: { x: { ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } }, y: { beginAtZero: false, min: 2000, max: 10000, title: { display: true, text: 'Nombre de Voix (1er Tour)', color: FONT_COLOR }, ticks: { color: FONT_COLOR }, grid: { color: GRID_COLOR } } }
                }
            });
            
            // Mise à jour de l'interface au chargement initial (important pour les détails et le 2nd tour)
            updateSimulation(); 


            // --- Gestion des Sliders (Section 4 et 6) ---

            const participationSlider = document.getElementById('participation-slider');
            const erosionSlider = document.getElementById('erosion-slider');
            const scoreProjetéSlider = document.getElementById('score-projeté-slider');

            // Événements d'écoute pour les sliders du 1er tour et du CMP
            participationSlider.addEventListener('input', updateSimulation);
            erosionSlider.addEventListener('input', updateSimulation);
            scoreProjetéSlider.addEventListener('input', updateSimulation);
            
            const arbitrageSlider = document.getElementById('laurent-arbitrage-slider');
            const arbitrageValueSpan = document.getElementById('laurent-arbitrage-value');
            
            // Initialisation de la variable globale au chargement
            laurentSupportRate = parseInt(arbitrageSlider.value, 10) / 100;

            arbitrageSlider.addEventListener('input', (event) => {
                // Mettre à jour la variable globale du support de Laurent
                laurentSupportRate = parseInt(event.target.value, 10) / 100;
                arbitrageValueSpan.textContent = `${(laurentSupportRate * 100).toFixed(0)}%`;
                
                // Lire les résultats actuels du 1er tour (sans recalculer l'érosion)
                const currentEpsilon = parseInt(erosionSlider.value, 10) / 100;
                const firstTourResults = calculate2026Projection(currentEpsilon);
                
                // Recalculer le 2nd tour immédiatement avec le nouveau taux de report
                updateSecondTourProjection(firstTourResults);
            });
            
            // Mettre à jour l'affichage de la valeur initiale du slider de Laurent
            arbitrageValueSpan.textContent = `${(laurentSupportRate * 100).toFixed(0)}%`;
        };
    </script>
</body>
</html>
